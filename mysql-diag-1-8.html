---
title: Running mysql-diag
owner: MySQL
---

This topic discusses how to use the `mysql-diag` tool in Pivotal MySQL. `mysql-diag` relays the state of your MySQL service and suggests steps to take in the event of a node failure. In conjunction with Support, this tool helps expedite the diagnosis and resolution of problems with MySQL. 

In Pivotal MySQL 1.9.0+, `mysql-diag` is automatically installed and configured. If you are running Pivotal MySQL 1.8.x and under, then you will need to create a configuration file in order to use `mysql-diag`.


## <a id="prepare"></a> Prepare Your Environment ##
Pivotal MySQL 1.9.0+ ships with the `mysql-diag` and comes with an automatically generated configuration file. If you are running Pivotal MySQL 1.8.x and under, then you will need to download `mysql-diag` and create a configuration file.

Only complete the installation instructions below if you are on Pivotal MySQL 1.8.x and below.

To download `mysql-diag`:

1. Download the file labeled **mysql-diag.conf** attached to the [Diagnosing problems with Elastic Runtime MySQL or the Pivotal MySQL Tile](https://discuss.pivotal.io/hc/en-us/articles/115001980967-Diagnosing-problems-with-Elastic-Runtime-MySQL-or-the-Pivotal-MySQL-Tile) Knowledge Base article. 

1. Copy that binary to the `mysql-monitor` VM with the following command:
`bosh scp <job_name> <job_instance_number> --upload <local_file_path> <remote_file_path>`

1. Execute that binary

To configure `mysql-diag`:


1. Paste the template below into a text editor

Configuration File Template

{
    "mysql": {
      "username": "repcanary",
      "password": "password",
      "port": 3306,
      "nodes": [                             
        {
          "host": "10.244.7.4",
        },
        {
          "host": "10.244.8.4",
        },
        {
          "host": "10.244.9.4",
        }
      ]
    }
  }

1. Replace the passwords with the values that you find in the OpsMan UI under the ‘Credentials’ tab.

1. Copy the completed template into the same VM that you downloaded the `mysql-diag` tool, using the `bosh scp` command.

1. Put the configuration file in the same directory as the `mysql-diag` tool. 

1. Run the following command
<pre class="terminal">$ mysql-diag -c ./diag-config.json</pre>

## <a id="diag-agent"></a> mysql-diag-agent ##

Pivotal MySQL 1.9.0 and above will have the `mysql-diag-agent` present. Versions 1.8.x and below of Pivotal MySQL do not have the `mysql-diag-agent`. If the `mysql-diag-agent` is not available, your output from the `mysql-diag` tool will not include the percentage of Persistent and Ephemeral Disk space used by a Host.

## <a id="output"></a> View Output ##

Upon running `mysql-diag` in your terminal, you will see the following if your canary status is healthy:
 
<pre class="terminal">Checking canary status...healthy</pre> 

Here is a sample `mysql-diag` output after the tool identified a healthy cluster:  

<pre class="terminal">
Checking cluster status of mysql/a1 at 10.0.16.44 ...
Checking cluster status of mysql/c3 at 10.0.32.10 ...
Checking cluster status of mysql/b2 at 10.0.16.45 ...
Checking cluster status of mysql/a1 at 10.0.16.44 ... done
Checking cluster status of mysql/c3 at 10.0.32.10 ... done
Checking cluster status of mysql/b2 at 10.0.16.45 ... done
+------------+-----------+-------------------+----------------------+--------------------+
|    HOST    | NAME/UUID | WSREP LOCAL STATE | WSREP CLUSTER STATUS | WSREP CLUSTER SIZE |
+------------+-----------+-------------------+----------------------+--------------------+
| 10.0.16.44 | mysql/a1  | Synced            | Primary              |                  3 |
| 10.0.32.10 | mysql/c3  | Synced            | Primary              |                  3 |
| 10.0.16.45 | mysql/b2  | Synced            | Primary              |                  3 |
+------------+-----------+-------------------+----------------------+--------------------+
I don't think bootstrap is necessary
Checking disk status of mysql/a1 at 10.0.16.44 ...
Checking disk status of mysql/c3 at 10.0.32.10 ...
Checking disk status of mysql/b2 at 10.0.16.45 ...
Checking disk status of mysql/a1 at 10.0.16.44 ... dial tcp 10.0.16.44: getsockopt: connection refuse
Checking disk status of mysql/c3 at 10.0.32.10 ... dial tcp 10.0.16.44: getsockopt: connection refuse
Checking disk status of mysql/b2 at 10.0.16.45 ... dial tcp 10.0.16.44: getsockopt: connection refuse

</pre>

Upon running `mysql-diag` in your terminal, you will see the following if your canary status is unhealthy:

<pre class="terminal">Checking canary status...unhealthy</pre> 

In the event of a broken cluster, running `mysql-diag` will output actionable steps meant to expedite that cluster’s recovery. Below is a sample `mysql-diag` output after the tool identified an unhealthy cluster:  

<pre class="terminal">Checking cluster status of mysql/a1 at 10.0.16.44 ...
Checking cluster status of mysql/c3 at 10.0.32.10 ...
Checking cluster status of mysql/b2 at 10.0.16.45 ...
Checking cluster status of mysql/a1 at 10.0.16.44 ... dial tcp 10.0.16.44: getsockopt: connection refused
Checking cluster status of mysql/c3 at 10.0.32.10 ... dial tcp 10.0.32.10: getsockopt: connection refused
Checking cluster status of mysql/b2 at 10.0.16.45 ... dial tcp 10.0.16.45: getsockopt: connection refused

+------------+-----------+-------------------+----------------------+--------------------+
|    HOST    | NAME/UUID | WSREP LOCAL STATE | WSREP CLUSTER STATUS | WSREP CLUSTER SIZE |
+------------+-----------+-------------------+----------------------+--------------------+
| 10.0.16.44 | mysql/a1  | N/A - ERROR       | N/A - ERROR          | N/A - ERROR        |
| 10.0.16.45 | mysql/b2  | N/A - ERROR       | N/A - ERROR          | N/A - ERROR        | 
| 10.0.32.10 | mysql/c3  | N/A - ERROR       | N/A - ERROR          | N/A - ERROR        |
+------------+-----------+-------------------+----------------------+--------------------+

Checking disk status of mysql/a1 at 10.0.16.44 ...
Checking disk status of mysql/c3 at 10.0.32.10 ...
Checking disk status of mysql/b2 at 10.0.16.45 ...
Checking disk status of mysql/a1 at 10.0.16.44 ... dial tcp 10.0.16.44: getsockopt: connection refused
Checking disk status of mysql/c3 at 10.0.32.10 ... dial tcp 10.0.32.10: getsockopt: connection refused
Checking disk status of mysql/b2 at 10.0.16.45 ... dial tcp 10.0.16.45: getsockopt: connection refused


[CRITICAL] The replication process is unhealthy. Writes are disabled.

[CRITICAL] Run the download-logs command:
$ download-logs -d /tmp/output -n 10.0.16.44 -n 10.16.45 -n 10.0.32.10
For full information about how to download and use the download-logs command see https://discuss.pivotal.io/hc/en-us/articles/221504408

[WARNING]
Do not perform the following unless instructed by Pivotal Support:
- Do not scale down the cluster to one node then scale back. This puts user data at risk.
- Avoid “bosh recreate” and “bosh cck”. These options remove logs on the VMs making it harder to diagnose cluster issues. 

</pre>




